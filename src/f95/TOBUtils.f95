!> @brief
!! TOB-adjustment utility module.  All calibration tables (ported verbatim
!! from the v6 BLOCK DATA) and every scientific subroutine needed to compute
!! time-of-observation bias estimates live here.  The module is stateless
!! except for one per-station quadrant-neighbor cache that is
!! automatically invalidated whenever the station coordinates change.
!!
!! Algorithm reference: Karl, T. R., et al., "The Homogeneity of U.S.
!! Daily and Monthly Surface Climatological Data", Journal of Climate
!! and Applied Meteorology, 1986.
!!
!! @copyright
!! THIS SOFTWARE AND ITS DOCUMENTATION ARE CONSIDERED TO BE IN THE PUBLIC
!! DOMAIN AND THUS ARE AVAILABLE FOR UNRESTRICTED PUBLIC USE. THEY ARE
!! FURNISHED "AS IS." THE AUTHORS, THE UNITED STATES GOVERNMENT, ITS
!! INSTRUMENTALITIES, OFFICERS, EMPLOYEES, AND AGENTS MAKE NO WARRANTY,
!! EXPRESS OR IMPLIED, AS TO THE USEFULNESS OF THE SOFTWARE AND
!! DOCUMENTATION FOR ANY PURPOSE. THEY ASSUME NO RESPONSIBILITY (1) FOR
!! THE USE OF THE SOFTWARE AND DOCUMENTATION; OR (2) TO PROVIDE TECHNICAL
!! SUPPORT TO USERS.
!!
module TOBUtils

  use AlgorithmParameters
  use Logger

  implicit none
  private

  public :: decode_obtime, tobchg, get_timezone, compute_bias_tables

  ! ---------------------------------------------------------------------------
  ! Calibration tables – ported from ushcn_tobs.v6.f BLOCK DATA
  ! ---------------------------------------------------------------------------
  integer, parameter :: NSTA_TOB = 130

  real, parameter :: ALAT(NSTA_TOB) = (/ &
        40.70, 41.93, 41.78, 42.90, 44.48, 48.57, &
        37.70, 36.08, 33.93, 33.43, 38.88, 36.12, &
        43.12, 44.38, 33.65, 34.90, 40.15, 36.77, &
        32.13, 29.18, 29.65, 25.82, 35.87, 33.95, &
        33.57, 35.18, 41.80, 47.48, 47.45, 43.42, &
        35.10, 33.23, 35.27, 30.38, 39.90, 40.50, &
        29.98, 25.90, 35.05, 32.47, 30.30, 39.50, &
        43.57, 35.40, 38.52, 43.12, 38.05, 37.77, &
        42.42, 46.47, 39.12, 46.43, 40.77, 47.62, &
        45.60, 27.97, 38.75, 35.23, 37.50, 43.20, &
        32.12, 35.33, 46.60, 39.07, 44.47, 43.87, &
        42.92, 44.77, 32.43, 39.77, 38.07, 46.77, &
        41.13, 43.65, 31.80, 35.05, 32.90, 35.43, &
        35.82, 47.00, 45.00, 42.00, 40.50, 39.00, &
        38.00, 36.50, 35.50, 34.00, 35.50, 33.50, &
        32.50, 28.50, 28.50, 30.00, 30.50, 39.00, &
        40.00, 45.00, 46.00, 45.00, 44.50, 44.00, &
        32.70, 36.08, 36.88, 37.32, 35.03, 30.42, &
        32.30, 37.23, 40.22, 41.73, 40.00, 41.00, &
        43.13, 42.08, 46.90, 41.45, 41.53, 42.38, &
        39.37, 35.42, 34.65, 32.73, 41.15, 45.80, &
        45.68, 42.37, 46.57, 38.03 /)

  real, parameter :: ALON(NSTA_TOB) = (/ &
        -74.17, -72.68, -87.75, -85.67, -88.13, -93.38, &
        -112.15, -115.17, -118.38, -112.02, -79.85, -86.68, &
        -77.67, -98.22, -101.83, -120.45, -122.25, -119.72, &
        -81.20, -81.05, -95.28, -80.28, -78.78, -83.32, &
        -86.75, -103.60, -107.20, -111.37, -122.30, -124.25, &
        -108.80, -107.27, -75.55, -84.37, -84.22, -80.22, &
        -90.25, -97.43, -89.98, -93.82, -97.70, -119.78, &
        -116.22, -97.60, -121.50, -76.12, -87.53, -99.97, &
        -83.02, -84.37, -108.53, -105.87, -111.97, -117.52, &
        -122.60, -82.53, -90.38, -101.70, -77.33, -71.50, &
        -110.93, -94.37, -112.00, -95.63, -73.15, -91.25, &
        -112.60, -106.97, -99.68, -104.88, -117.08, -100.75, &
        -100.68, -70.32, -106.40, -106.62, -80.03, -82.55, &
        -83.98, -123.50, -123.50, -124.00, -124.00, -123.50, &
        -122.00, -121.50, -120.50, -117.00, -116.50, -115.00, &
        -113.50, -99.50, -97.00, -92.50, -87.50, -75.50, &
        -74.50, -68.00, -69.00, -70.50, -84.00, -86.00, &
        -83.65, -79.95, -76.20, -79.97, -85.20, -81.65, &
        -86.40, -93.38, -76.85, -71.43, -82.88, -85.22, &
        -89.33, -80.18, -96.80, -90.52, -93.65, -96.37, &
        -101.70, -119.05, -112.43, -117.17, -104.82, -108.53, &
        -118.85, -122.87, -120.53, -84.60 /)

  real, parameter :: BASAV(12, 24) = reshape((/ &
        0.40, 0.32, 0.35, 0.36, 0.38, 0.43, &
        0.47, 0.54, 0.49, 0.51, 0.54, 0.52, &
        0.31, 0.25, 0.27, 0.28, 0.28, 0.31, &
        0.34, 0.39, 0.37, 0.39, 0.43, 0.41, &
        0.22, 0.18, 0.19, 0.21, 0.21, 0.23, &
        0.25, 0.28, 0.26, 0.27, 0.31, 0.32, &
        0.14, 0.11, 0.12, 0.14, 0.15, 0.16, &
        0.19, 0.20, 0.18, 0.19, 0.22, 0.23, &
        0.06, 0.04, 0.05, 0.07, 0.09, 0.10, &
        0.13, 0.14, 0.13, 0.14, 0.15, 0.17, &
        -0.03, -0.02, -0.02, 0.00, 0.02, 0.04, &
        0.07, 0.09, 0.09, 0.09, 0.10, 0.13, &
        -0.10, -0.09, -0.09, -0.07, -0.05, -0.03, &
        0.00, 0.03, 0.04, 0.05, 0.06, 0.08, &
        -0.17, -0.15, -0.16, -0.14, -0.12, -0.10, &
        -0.07, -0.03, -0.01, 0.00, 0.01, 0.02, &
        -0.25, -0.22, -0.23, -0.21, -0.19, -0.17, &
        -0.15, -0.11, -0.07, -0.06, -0.05, -0.04, &
        -0.32, -0.28, -0.29, -0.28, -0.26, -0.24, &
        -0.22, -0.18, -0.13, -0.13, -0.12, -0.12, &
        -0.38, -0.33, -0.35, -0.34, -0.33, -0.31, &
        -0.29, -0.26, -0.21, -0.20, -0.20, -0.21, &
        -0.43, -0.37, -0.39, -0.39, -0.39, -0.37, &
        -0.36, -0.33, -0.28, -0.27, -0.28, -0.30, &
        -0.45, -0.38, -0.41, -0.41, -0.43, -0.42, &
        -0.41, -0.39, -0.34, -0.33, -0.35, -0.38, &
        -0.30, -0.19, -0.23, -0.24, -0.26, -0.26, &
        -0.25, -0.26, -0.22, -0.22, -0.25, -0.28, &
        0.01, 0.10, 0.05, 0.04, 0.02, 0.02, &
        0.01, 0.01, 0.02, 0.02, -0.01, -0.01, &
        0.27, 0.28, 0.25, 0.23, 0.17, 0.17, &
        0.15, 0.13, 0.12, 0.12, 0.11, 0.13, &
        0.51, 0.45, 0.42, 0.39, 0.30, 0.27, &
        0.24, 0.20, 0.16, 0.16, 0.15, 0.17, &
        0.73, 0.61, 0.61, 0.55, 0.44, 0.39, &
        0.34, 0.28, 0.21, 0.21, 0.20, 0.19, &
        0.91, 0.77, 0.78, 0.72, 0.60, 0.54, &
        0.46, 0.39, 0.28, 0.28, 0.26, 0.23, &
        1.01, 0.88, 0.89, 0.84, 0.74, 0.69, &
        0.60, 0.52, 0.39, 0.37, 0.35, 0.31, &
        1.00, 0.87, 0.90, 0.89, 0.82, 0.80, &
        0.72, 0.64, 0.49, 0.48, 0.45, 0.41, &
        0.85, 0.75, 0.80, 0.81, 0.80, 0.82, &
        0.77, 0.72, 0.59, 0.57, 0.56, 0.51, &
        0.65, 0.56, 0.61, 0.65, 0.69, 0.75, &
        0.74, 0.73, 0.62, 0.62, 0.62, 0.59, &
        0.51, 0.42, 0.45, 0.49, 0.52, 0.60, &
        0.63, 0.66, 0.59, 0.59, 0.61, 0.59 /), (/12, 24/))

  real, parameter :: BASMN(12, 24) = reshape((/ &
        0.51, 0.43, 0.46, 0.47, 0.43, 0.41, &
        0.41, 0.38, 0.31, 0.31, 0.31, 0.35, &
        0.41, 0.35, 0.37, 0.39, 0.38, 0.37, &
        0.38, 0.36, 0.30, 0.30, 0.30, 0.34, &
        0.30, 0.26, 0.28, 0.31, 0.31, 0.31, &
        0.34, 0.33, 0.28, 0.28, 0.28, 0.32, &
        0.19, 0.17, 0.19, 0.21, 0.23, 0.24, &
        0.28, 0.28, 0.24, 0.25, 0.26, 0.30, &
        0.08, 0.07, 0.08, 0.11, 0.14, 0.16, &
        0.20, 0.22, 0.20, 0.21, 0.22, 0.26, &
        -0.04, -0.04, -0.03, 0.00, 0.03, 0.06, &
        0.11, 0.14, 0.14, 0.15, 0.16, 0.21, &
        -0.15, -0.14, -0.14, -0.11, -0.08, -0.04, &
        0.00, 0.05, 0.07, 0.08, 0.10, 0.14, &
        -0.26, -0.24, -0.26, -0.22, -0.20, -0.16, &
        -0.12, -0.06, -0.02, 0.00, 0.01, 0.04, &
        -0.36, -0.34, -0.36, -0.34, -0.32, -0.29, &
        -0.26, -0.19, -0.13, -0.11, -0.09, -0.07, &
        -0.46, -0.44, -0.47, -0.46, -0.45, -0.42, &
        -0.39, -0.32, -0.25, -0.23, -0.22, -0.22, &
        -0.56, -0.53, -0.56, -0.56, -0.57, -0.55, &
        -0.52, -0.46, -0.38, -0.36, -0.36, -0.38, &
        -0.63, -0.60, -0.64, -0.66, -0.68, -0.67, &
        -0.65, -0.61, -0.52, -0.51, -0.52, -0.56, &
        -0.66, -0.63, -0.67, -0.70, -0.74, -0.75, &
        -0.74, -0.72, -0.64, -0.63, -0.66, -0.72, &
        -0.36, -0.24, -0.32, -0.35, -0.40, -0.43, &
        -0.41, -0.44, -0.38, -0.40, -0.44, -0.51, &
        0.20, 0.28, 0.21, 0.18, 0.12, 0.12, &
        0.11, 0.09, 0.09, 0.08, 0.05, 0.04, &
        0.54, 0.52, 0.49, 0.46, 0.37, 0.36, &
        0.35, 0.32, 0.29, 0.29, 0.28, 0.32, &
        0.71, 0.62, 0.61, 0.57, 0.47, 0.45, &
        0.43, 0.39, 0.34, 0.34, 0.34, 0.38, &
        0.79, 0.66, 0.65, 0.62, 0.51, 0.48, &
        0.46, 0.41, 0.35, 0.35, 0.35, 0.39, &
        0.81, 0.67, 0.67, 0.63, 0.53, 0.48, &
        0.46, 0.42, 0.35, 0.35, 0.36, 0.39, &
        0.81, 0.66, 0.66, 0.63, 0.53, 0.48, &
        0.46, 0.42, 0.35, 0.35, 0.35, 0.39, &
        0.80, 0.65, 0.65, 0.63, 0.53, 0.48, &
        0.46, 0.41, 0.34, 0.34, 0.35, 0.38, &
        0.75, 0.62, 0.63, 0.61, 0.52, 0.47, &
        0.46, 0.41, 0.33, 0.33, 0.34, 0.38, &
        0.69, 0.57, 0.59, 0.58, 0.50, 0.46, &
        0.45, 0.40, 0.33, 0.33, 0.33, 0.37, &
        0.61, 0.51, 0.53, 0.53, 0.47, 0.44, &
        0.44, 0.39, 0.32, 0.32, 0.32, 0.36 /), (/12, 24/))

  real, parameter :: BASMX(12, 24) = reshape((/ &
        0.29, 0.22, 0.24, 0.26, 0.32, 0.46, &
        0.53, 0.70, 0.67, 0.71, 0.76, 0.70, &
        0.22, 0.15, 0.16, 0.17, 0.19, 0.26, &
        0.29, 0.43, 0.44, 0.48, 0.55, 0.50, &
        0.15, 0.10, 0.10, 0.11, 0.12, 0.15, &
        0.17, 0.23, 0.24, 0.27, 0.34, 0.33, &
        0.09, 0.06, 0.06, 0.06, 0.07, 0.09, &
        0.10, 0.12, 0.13, 0.13, 0.17, 0.17, &
        0.04, 0.02, 0.02, 0.03, 0.04, 0.05, &
        0.05, 0.07, 0.07, 0.07, 0.08, 0.08, &
        -0.02, -0.01, -0.01, 0.00, 0.01, 0.02, &
        0.02, 0.03, 0.04, 0.04, 0.04, 0.05, &
        -0.06, -0.04, -0.04, -0.03, -0.02, -0.01, &
        0.00, 0.01, 0.01, 0.02, 0.02, 0.02, &
        -0.10, -0.07, -0.07, -0.06, -0.04, -0.03, &
        -0.02, -0.01, 0.00, 0.00, 0.00, 0.01, &
        -0.13, -0.09, -0.09, -0.08, -0.06, -0.04, &
        -0.04, -0.02, -0.02, -0.01, -0.01, -0.01, &
        -0.17, -0.11, -0.11, -0.09, -0.08, -0.06, &
        -0.05, -0.04, -0.02, -0.02, -0.02, -0.02, &
        -0.20, -0.12, -0.13, -0.11, -0.09, -0.07, &
        -0.06, -0.05, -0.03, -0.03, -0.03, -0.03, &
        -0.22, -0.14, -0.14, -0.12, -0.10, -0.07, &
        -0.07, -0.05, -0.04, -0.04, -0.04, -0.03, &
        -0.25, -0.14, -0.15, -0.13, -0.11, -0.08, &
        -0.08, -0.06, -0.05, -0.04, -0.05, -0.04, &
        -0.24, -0.14, -0.15, -0.12, -0.11, -0.08, &
        -0.08, -0.07, -0.05, -0.05, -0.05, -0.04, &
        -0.18, -0.09, -0.11, -0.09, -0.09, -0.07, &
        -0.08, -0.07, -0.05, -0.05, -0.06, -0.05, &
        0.01, 0.04, 0.00, 0.00, -0.03, -0.03, &
        -0.05, -0.05, -0.05, -0.05, -0.06, -0.06, &
        0.32, 0.27, 0.24, 0.20, 0.12, 0.09, &
        0.04, 0.01, -0.02, -0.02, -0.03, -0.05, &
        0.69, 0.57, 0.56, 0.49, 0.38, 0.30, &
        0.21, 0.15, 0.07, 0.06, 0.04, -0.02, &
        1.02, 0.88, 0.89, 0.81, 0.67, 0.59, &
        0.46, 0.36, 0.21, 0.21, 0.16, 0.06, &
        1.22, 1.09, 1.11, 1.06, 0.94, 0.88, &
        0.74, 0.63, 0.42, 0.40, 0.35, 0.23, &
        1.20, 1.10, 1.15, 1.15, 1.11, 1.11, &
        0.97, 0.87, 0.64, 0.62, 0.56, 0.44, &
        0.95, 0.88, 0.96, 1.02, 1.09, 1.18, &
        1.09, 1.03, 0.83, 0.81, 0.78, 0.64, &
        0.62, 0.55, 0.64, 0.73, 0.88, 1.05, &
        1.03, 1.06, 0.91, 0.90, 0.91, 0.81, &
        0.41, 0.33, 0.38, 0.44, 0.58, 0.77, &
        0.83, 0.94, 0.85, 0.87, 0.90, 0.82 /), (/12, 24/))

  real, parameter :: CFAV(12) = (/ 0.31922, 0.37431, 0.44731, 0.50498, 0.56846, 0.56295, 0.52204, 0.48322, 0.44204, 0.42144, 0.36685, 0.11857 /)

  real, parameter :: CFMN(12) = (/ 0.32202, 0.38046, 0.45206, 0.47658, 0.55423, 0.55926, 0.52539, 0.49406, 0.41774, 0.40619, 0.36537, 0.11671 /)

  real, parameter :: CFMX(12) = (/ 0.31180, 0.36147, 0.43151, 0.50968, 0.55989, 0.56033, 0.53689, 0.49398, 0.46986, 0.44970, 0.36621, 0.12074 /)

  real, parameter :: DTDIF(12, NSTA_TOB) = reshape((/ &
        2.91, 3.20, 2.54, 2.82, 2.77, 2.29, &
        1.87, 1.83, 2.29, 2.60, 2.71, 2.72, &
        3.48, 3.66, 2.38, 2.75, 2.70, 2.43, &
        1.85, 2.20, 2.61, 2.84, 3.07, 3.18, &
        3.35, 3.22, 2.49, 3.30, 3.33, 2.62, &
        1.89, 1.96, 2.52, 2.73, 3.07, 3.25, &
        2.93, 3.27, 2.32, 2.90, 2.97, 2.16, &
        1.74, 1.84, 2.58, 2.71, 2.72, 2.93, &
        3.45, 3.53, 2.68, 2.94, 3.06, 2.44, &
        1.99, 2.37, 2.80, 2.66, 2.97, 3.33, &
        4.22, 4.04, 2.98, 2.84, 3.01, 2.30, &
        2.03, 2.31, 2.96, 2.90, 2.95, 4.30, &
        2.51, 2.55, 2.37, 2.17, 1.75, 1.45, &
        1.16, 1.21, 1.52, 1.54, 2.04, 2.25, &
        1.92, 1.73, 1.84, 2.13, 1.71, 1.52, &
        1.29, 1.31, 1.57, 1.52, 1.60, 1.49, &
        1.59, 1.21, 1.22, 1.20, 0.74, 0.61, &
        0.65, 0.76, 1.14, 1.28, 1.40, 1.46, &
        1.62, 1.44, 1.44, 1.58, 1.37, 1.08, &
        1.18, 1.39, 1.14, 1.28, 1.41, 1.25, &
        3.80, 4.01, 3.12, 2.86, 2.49, 1.76, &
        1.31, 1.41, 1.92, 2.41, 3.19, 3.61, &
        3.97, 3.95, 3.01, 2.81, 2.07, 1.55, &
        1.15, 1.29, 1.69, 2.22, 3.08, 3.33, &
        3.26, 3.69, 2.92, 3.30, 3.26, 2.58, &
        1.96, 2.09, 2.88, 3.03, 2.98, 2.98, &
        4.17, 3.90, 3.16, 3.25, 3.04, 2.54, &
        2.10, 2.66, 3.85, 3.40, 3.44, 4.25, &
        3.69, 3.49, 3.44, 3.11, 2.35, 1.89, &
        1.52, 1.34, 2.07, 2.49, 3.52, 3.39, &
        1.62, 1.37, 1.38, 1.66, 1.33, 1.02, &
        0.89, 1.04, 1.40, 1.56, 1.70, 1.54, &
        2.33, 1.63, 1.69, 1.75, 1.88, 2.07, &
        1.67, 1.61, 1.89, 1.71, 1.73, 1.90, &
        1.63, 1.31, 1.52, 1.77, 1.52, 1.86, &
        1.26, 1.29, 1.65, 1.49, 1.31, 1.38, &
        3.29, 3.21, 2.91, 2.36, 1.66, 1.19, &
        0.93, 1.07, 1.51, 1.90, 2.73, 3.10, &
        3.36, 2.96, 2.85, 2.03, 1.16, 0.87, &
        0.78, 0.72, 0.91, 1.37, 2.03, 2.78, &
        3.66, 3.00, 2.63, 1.75, 1.19, 0.92, &
        0.70, 0.78, 0.99, 1.57, 2.71, 3.01, &
        2.50, 2.31, 1.96, 1.34, 0.90, 0.62, &
        0.61, 0.68, 0.67, 0.91, 1.34, 1.96, &
        3.57, 3.65, 2.91, 2.84, 2.38, 1.75, &
        1.17, 1.36, 1.95, 2.34, 3.09, 3.31, &
        2.97, 3.00, 2.58, 2.38, 1.81, 1.40, &
        1.02, 1.02, 1.61, 1.92, 2.53, 2.90, &
        3.40, 3.26, 2.91, 2.57, 1.73, 1.26, &
        0.98, 1.07, 1.45, 1.90, 2.81, 3.06, &
        3.71, 3.30, 3.35, 3.12, 2.50, 1.85, &
        1.59, 1.56, 2.48, 2.79, 3.45, 3.53, &
        4.07, 3.08, 3.10, 2.92, 2.18, 1.72, &
        1.50, 1.72, 2.26, 2.75, 3.32, 3.28, &
        4.69, 3.73, 3.09, 3.29, 2.58, 2.25, &
        2.24, 2.58, 3.40, 3.61, 4.35, 4.14, &
        1.89, 1.37, 1.35, 1.53, 1.61, 1.74, &
        1.65, 1.48, 1.40, 1.57, 1.69, 1.92, &
        1.71, 1.41, 1.13, 1.26, 1.05, 0.82, &
        0.93, 1.06, 1.28, 1.56, 1.70, 1.65, &
        2.36, 2.04, 2.19, 2.08, 1.67, 1.27, &
        1.13, 1.10, 1.19, 1.37, 1.93, 1.79, &
        2.24, 2.20, 2.26, 2.22, 1.58, 1.20, &
        1.28, 1.14, 1.28, 1.47, 1.98, 1.93, &
        3.51, 3.59, 2.81, 2.49, 1.93, 1.53, &
        1.15, 1.33, 1.35, 2.13, 2.98, 3.17, &
        3.11, 2.77, 2.52, 1.92, 1.35, 1.00, &
        0.79, 0.80, 1.01, 1.75, 2.50, 2.80, &
        3.64, 3.63, 2.97, 3.05, 2.79, 2.10, &
        1.54, 1.78, 2.31, 2.59, 3.07, 3.51, &
        3.54, 3.74, 2.98, 3.05, 2.74, 2.29, &
        1.68, 1.82, 2.21, 2.51, 3.25, 3.49, &
        3.47, 2.99, 2.86, 1.79, 1.26, 0.79, &
        0.74, 0.82, 1.05, 1.53, 2.70, 3.31, &
        3.55, 3.29, 2.67, 1.60, 0.95, 0.73, &
        0.51, 0.62, 0.97, 1.51, 2.45, 3.08, &
        3.87, 3.53, 2.94, 2.56, 1.88, 1.46, &
        1.05, 1.18, 1.72, 2.08, 3.10, 3.18, &
        3.76, 3.20, 2.74, 2.32, 1.67, 1.11, &
        0.90, 1.13, 1.34, 1.94, 2.93, 3.13, &
        3.54, 3.31, 3.04, 2.35, 1.55, 1.06, &
        0.70, 0.94, 1.29, 1.76, 3.04, 3.01, &
        2.40, 1.97, 2.03, 1.99, 1.81, 1.72, &
        1.36, 1.44, 1.57, 1.74, 2.09, 2.08, &
        2.42, 1.80, 2.07, 2.60, 2.42, 2.53, &
        2.12, 2.21, 2.34, 2.29, 2.48, 2.09, &
        3.84, 3.57, 3.63, 2.99, 2.14, 1.56, &
        1.37, 1.59, 2.19, 2.32, 3.27, 3.28, &
        1.76, 1.28, 1.41, 1.65, 1.54, 1.91, &
        1.61, 1.65, 1.67, 1.36, 1.56, 1.42, &
        3.54, 3.91, 2.83, 3.05, 3.16, 2.56, &
        1.77, 2.02, 2.50, 3.02, 3.01, 3.38, &
        3.91, 3.71, 3.28, 2.94, 2.36, 1.87, &
        1.44, 1.72, 2.06, 2.64, 3.31, 3.44, &
        3.72, 3.53, 3.38, 3.28, 2.78, 2.08, &
        1.95, 2.15, 2.87, 3.03, 3.50, 3.50, &
        2.91, 3.26, 2.69, 3.04, 3.11, 2.54, &
        1.89, 2.00, 2.59, 2.75, 2.90, 2.77, &
        3.13, 3.70, 2.58, 2.41, 2.88, 2.44, &
        2.01, 2.09, 2.52, 2.57, 2.57, 3.53, &
        1.97, 1.87, 2.15, 2.56, 1.96, 1.70, &
        1.22, 1.62, 1.75, 1.72, 1.81, 1.77, &
        3.87, 3.44, 2.84, 3.11, 2.79, 2.61, &
        2.49, 2.80, 3.38, 3.02, 3.53, 3.74, &
        2.57, 2.30, 2.40, 2.71, 2.36, 2.13, &
        1.75, 1.96, 2.33, 2.49, 2.30, 2.03, &
        2.44, 1.85, 1.58, 2.06, 1.92, 2.15, &
        1.88, 2.01, 2.12, 2.06, 2.34, 2.12, &
        1.97, 1.49, 1.44, 1.74, 1.59, 1.69, &
        1.72, 1.55, 1.61, 1.79, 1.77, 1.85, &
        2.74, 2.36, 2.15, 1.40, 0.90, 0.66, &
        0.74, 0.70, 0.91, 1.19, 1.83, 2.38, &
        3.71, 3.71, 3.12, 3.21, 2.43, 2.10, &
        1.61, 1.79, 2.30, 2.71, 3.17, 3.48, &
        3.86, 3.67, 3.34, 3.21, 2.51, 1.91, &
        1.55, 1.49, 2.46, 2.76, 3.54, 3.62, &
        3.69, 3.68, 2.94, 3.23, 2.75, 2.01, &
        1.39, 1.63, 2.06, 2.33, 3.10, 3.17, &
        3.72, 4.05, 2.40, 2.73, 2.83, 2.48, &
        1.97, 2.19, 2.85, 3.00, 3.02, 3.23, &
        2.10, 1.76, 2.01, 1.82, 1.63, 1.19, &
        1.26, 1.14, 1.17, 1.38, 1.78, 1.56, &
        3.58, 2.93, 2.97, 2.57, 1.83, 1.34, &
        1.40, 1.58, 1.61, 1.96, 2.85, 3.01, &
        4.02, 3.39, 2.58, 2.67, 2.08, 1.99, &
        1.73, 1.87, 2.46, 2.50, 3.64, 3.73, &
        3.96, 3.20, 2.97, 3.20, 2.30, 1.89, &
        1.76, 2.06, 2.57, 2.71, 3.40, 3.62, &
        4.17, 4.49, 2.99, 2.67, 2.99, 2.63, &
        1.92, 2.16, 2.57, 3.17, 3.08, 3.74, &
        3.45, 3.45, 2.60, 2.82, 2.83, 2.26, &
        1.73, 2.19, 2.56, 2.78, 3.14, 3.44, &
        3.22, 2.30, 1.99, 2.56, 2.14, 1.89, &
        1.76, 1.80, 1.94, 2.17, 2.58, 2.55, &
        4.01, 3.29, 2.69, 2.99, 2.42, 1.99, &
        1.76, 2.16, 3.00, 2.96, 3.57, 3.70, &
        4.18, 4.04, 3.80, 3.18, 2.48, 1.51, &
        1.20, 1.19, 1.86, 2.46, 3.59, 3.61, &
        4.14, 3.40, 3.16, 3.13, 2.51, 2.23, &
        1.76, 1.94, 2.73, 2.69, 3.86, 3.81, &
        1.99, 1.89, 1.69, 2.18, 1.96, 1.58, &
        1.19, 1.19, 1.46, 1.60, 1.63, 1.72, &
        4.17, 4.03, 2.92, 3.11, 2.95, 2.38, &
        2.20, 2.84, 3.16, 3.31, 3.62, 4.19, &
        3.55, 3.23, 2.91, 2.94, 2.72, 2.37, &
        1.99, 2.31, 3.35, 2.72, 3.37, 3.57, &
        3.51, 4.06, 2.47, 2.46, 2.69, 2.53, &
        1.89, 2.07, 2.85, 2.99, 2.98, 3.06, &
        2.65, 2.52, 2.58, 2.25, 1.79, 1.28, &
        1.44, 1.08, 1.29, 1.47, 2.24, 2.30, &
        2.26, 1.98, 2.42, 2.39, 1.81, 1.27, &
        1.28, 1.22, 1.46, 1.57, 1.97, 1.94, &
        3.22, 3.32, 3.00, 2.43, 1.78, 1.38, &
        1.10, 1.08, 1.45, 1.92, 2.91, 3.25, &
        3.30, 3.26, 2.55, 2.74, 2.08, 1.42, &
        1.16, 1.24, 1.75, 2.08, 2.76, 3.14, &
        3.32, 3.18, 2.57, 2.64, 1.79, 1.32, &
        1.00, 1.04, 1.40, 1.86, 2.70, 2.82, &
        1.80, 1.10, 1.20, 1.30, 1.00, 1.10, &
        1.55, 1.25, 1.30, 1.60, 1.60, 1.60, &
        1.75, 1.25, 1.30, 1.45, 1.00, 1.00, &
        1.25, 1.25, 1.40, 1.60, 1.60, 1.60, &
        1.70, 1.20, 1.25, 1.50, 1.40, 1.00, &
        1.00, 1.20, 1.30, 1.60, 1.50, 1.60, &
        1.65, 1.20, 1.20, 1.50, 1.40, 1.10, &
        0.90, 0.95, 1.20, 1.55, 1.50, 1.50, &
        1.50, 1.00, 1.00, 1.50, 1.20, 1.00, &
        0.90, 0.90, 1.10, 1.40, 1.50, 1.20, &
        1.60, 1.10, 1.20, 1.45, 1.20, 1.00, &
        1.00, 1.00, 1.50, 1.40, 1.50, 1.20, &
        1.60, 1.10, 1.30, 1.50, 1.10, 1.20, &
        1.00, 1.00, 1.30, 1.50, 1.50, 1.20, &
        1.70, 1.20, 1.20, 1.70, 1.20, 1.20, &
        1.10, 1.10, 1.50, 1.50, 1.50, 1.20, &
        1.80, 1.30, 1.35, 1.40, 1.20, 0.90, &
        1.10, 1.20, 1.30, 1.30, 1.40, 1.50, &
        1.85, 1.40, 1.65, 2.10, 1.70, 1.10, &
        1.25, 1.30, 1.60, 1.50, 1.60, 1.70, &
        1.40, 1.35, 1.35, 1.35, 1.00, 0.80, &
        0.75, 1.15, 1.20, 1.30, 1.30, 1.30, &
        1.40, 1.20, 1.40, 1.40, 0.90, 0.90, &
        0.80, 1.15, 1.10, 1.30, 1.30, 1.30, &
        3.60, 3.20, 3.00, 1.80, 1.50, 1.00, &
        0.75, 0.85, 1.30, 1.70, 2.60, 3.20, &
        3.60, 3.10, 2.70, 1.65, 1.25, 0.80, &
        0.50, 0.70, 0.90, 1.40, 2.60, 3.10, &
        3.60, 2.90, 2.60, 1.60, 1.25, 0.80, &
        0.50, 0.80, 0.80, 1.50, 2.60, 3.10, &
        3.25, 2.60, 2.50, 1.60, 1.25, 0.90, &
        0.65, 0.80, 0.80, 1.50, 2.50, 2.90, &
        2.60, 3.20, 2.20, 2.70, 2.70, 2.20, &
        1.49, 1.60, 2.20, 2.40, 2.80, 2.60, &
        2.60, 3.10, 2.20, 2.70, 2.75, 2.30, &
        1.70, 1.80, 2.30, 2.55, 2.80, 2.60, &
        3.70, 4.20, 2.75, 2.70, 2.80, 2.70, &
        1.80, 2.20, 2.70, 3.10, 3.00, 3.20, &
        4.20, 4.50, 3.20, 2.80, 3.30, 2.80, &
        1.90, 2.25, 2.75, 3.30, 3.25, 3.60, &
        4.20, 4.50, 3.20, 2.85, 3.30, 2.70, &
        1.80, 2.20, 2.70, 3.30, 3.25, 3.60, &
        2.65, 3.40, 2.40, 2.60, 3.45, 2.20, &
        1.90, 2.25, 2.70, 2.60, 2.80, 3.30, &
        2.85, 3.50, 2.45, 2.70, 3.30, 2.20, &
        1.80, 2.20, 2.70, 2.70, 2.90, 3.30, &
        2.91, 3.19, 2.70, 2.43, 1.73, 1.23, &
        0.97, 0.97, 1.52, 1.82, 2.60, 3.01, &
        3.44, 3.57, 2.84, 2.82, 2.29, 1.69, &
        1.39, 1.33, 1.90, 2.30, 2.83, 3.10, &
        3.64, 3.59, 3.02, 3.06, 2.80, 2.11, &
        1.40, 1.52, 1.77, 2.08, 2.99, 3.07, &
        3.59, 3.75, 2.93, 2.91, 2.48, 1.91, &
        1.46, 1.49, 2.05, 2.37, 2.80, 3.10, &
        3.13, 3.18, 2.41, 2.54, 1.84, 1.25, &
        1.02, 0.99, 1.42, 1.79, 2.51, 2.79, &
        3.51, 3.22, 2.92, 2.29, 1.45, 1.07, &
        0.89, 0.97, 1.13, 1.55, 2.54, 2.98, &
        3.18, 3.13, 2.69, 2.11, 1.49, 0.99, &
        0.86, 0.73, 1.26, 1.82, 2.70, 2.98, &
        4.17, 3.71, 3.38, 3.16, 2.10, 1.64, &
        1.44, 1.66, 2.00, 2.53, 3.49, 3.57, &
        2.87, 3.06, 2.42, 2.79, 2.59, 2.16, &
        1.52, 1.87, 2.24, 2.44, 2.70, 2.69, &
        3.22, 3.41, 2.37, 2.75, 2.63, 2.34, &
        1.73, 1.89, 2.42, 2.86, 3.09, 2.80, &
        3.55, 3.50, 3.04, 3.09, 2.75, 2.20, &
        1.75, 1.81, 2.35, 2.57, 3.20, 3.66, &
        3.33, 3.39, 2.62, 3.12, 2.89, 2.22, &
        1.65, 1.91, 2.42, 2.75, 3.07, 3.24, &
        3.61, 3.50, 2.66, 2.95, 3.07, 2.37, &
        1.88, 2.32, 2.81, 2.90, 3.33, 3.51, &
        3.31, 4.01, 3.11, 3.62, 3.53, 2.85, &
        2.00, 2.07, 2.58, 2.76, 2.97, 3.00, &
        4.06, 3.82, 3.33, 3.24, 3.28, 2.45, &
        2.05, 2.60, 3.30, 3.33, 3.22, 4.20, &
        3.64, 3.41, 2.76, 3.07, 2.80, 2.31, &
        1.74, 2.09, 2.44, 2.90, 3.41, 3.40, &
        3.65, 3.39, 2.73, 3.08, 2.44, 2.13, &
        1.59, 2.09, 2.65, 2.78, 3.37, 3.65, &
        3.62, 3.64, 2.44, 2.85, 2.67, 2.21, &
        1.80, 1.92, 2.81, 2.91, 3.23, 3.77, &
        4.15, 3.59, 3.22, 3.10, 2.91, 2.52, &
        1.95, 2.22, 3.27, 3.02, 3.72, 3.87, &
        1.77, 1.53, 1.65, 2.05, 1.67, 1.83, &
        1.32, 1.26, 1.83, 1.73, 1.55, 1.52, &
        1.97, 1.75, 1.89, 2.00, 1.64, 1.24, &
        1.09, 1.07, 1.30, 1.30, 1.80, 1.66, &
        1.29, 1.08, 1.10, 1.06, 0.78, 0.63, &
        0.67, 0.66, 0.97, 1.10, 1.12, 1.24, &
        4.42, 3.66, 3.21, 3.11, 2.60, 2.27, &
        1.83, 2.16, 2.81, 3.01, 3.91, 3.83, &
        4.19, 3.39, 2.91, 3.20, 2.40, 2.35, &
        2.10, 2.29, 3.18, 3.24, 3.90, 3.68, &
        2.84, 2.02, 1.63, 2.09, 1.89, 2.17, &
        1.92, 2.04, 2.01, 2.11, 2.61, 2.48, &
        2.26, 1.82, 1.71, 1.88, 1.79, 1.87, &
        1.62, 1.47, 1.84, 1.72, 2.06, 2.04, &
        2.47, 1.89, 1.93, 2.08, 1.99, 2.12, &
        2.19, 1.94, 1.84, 1.88, 2.23, 1.96, &
        4.09, 3.78, 3.31, 3.05, 2.63, 1.92, &
        1.22, 1.56, 1.94, 2.61, 3.22, 3.66 /), (/12, 130/))

  real, parameter :: RELEV(12) = (/ 22.5, 28.5, 34.5, 40.5, 46.5, 52.5, 58.5, 64.5, 70.5, 76.5, 82.5, 90.0 /)

  real, parameter :: RHO(NSTA_TOB) = (/ &
        4.50, 5.77, 4.43, 3.66, 4.77, 5.54, &
        13.70, 10.97, 8.22, 12.65, 6.08, 6.61, &
        3.49, 6.60, 11.38, 12.39, 8.12, 8.58, &
        9.84, 7.97, 7.16, 6.86, 8.66, 8.64, &
        7.43, 12.19, 6.69, 4.15, 2.64, 4.53, &
        13.63, 12.10, 3.76, 9.53, 4.80, 4.41, &
        6.72, 7.12, 6.36, 7.33, 8.11, 12.91, &
        5.34, 7.66, 6.84, 3.55, 5.82, 8.84, &
        3.29, 3.81, 9.11, 6.37, 6.70, 2.82, &
        3.38, 8.77, 5.77, 10.26, 8.36, 7.21, &
        12.09, 8.57, 5.17, 7.47, 3.81, 4.71, &
        6.86, 6.62, 9.07, 10.45, 13.32, 6.41, &
        11.11, 6.61, 11.66, 10.17, 9.48, 8.40, &
        6.77, 2.50, 3.50, 5.00, 6.00, 6.50, &
        7.00, 8.00, 8.50, 10.00, 11.00, 13.00, &
        12.50, 8.50, 6.50, 7.00, 8.00, 7.00, &
        6.00, 4.50, 5.50, 5.50, 3.00, 3.00, &
        10.12, 8.39, 5.49, 6.30, 7.69, 8.90, &
        8.71, 7.52, 5.20, 5.20, 4.92, 4.77, &
        5.28, 2.56, 4.75, 5.33, 5.87, 6.91, &
        10.49, 8.77, 13.74, 8.51, 7.16, 4.98, &
        2.87, 5.56, 5.02, 5.59 /)

  ! ---------------------------------------------------------------------------
  ! Days per month (non-leap; February corrected at call-site)
  ! ---------------------------------------------------------------------------
  real, parameter :: DAYS_MON(12) = (/31.,28.,31.,30.,31.,30.,31.,31.,30.,31.,30.,31./)

  ! ---------------------------------------------------------------------------
  ! Quadrant-neighbor cache  (invalidated when station lat/lon changes)
  ! ---------------------------------------------------------------------------
  real,    save :: q_lat = -9999., q_lon = -9999.
  real,    save :: q_dz(4) = (/999., 999., 999., 999./)
  integer, save :: q_iz(4) = (/999, 999, 999, 999/)

contains

  ! ===========================================================================
  !  PUBLIC INTERFACES
  ! ===========================================================================

  !> Decode a 4-character observation-time string from a .his record into an
  !! integer code.  Matches the decoding logic in v3 GETOBT (lines 2089-2128).
  !!
  !! Codes 1-24: specific hour.  24 = midnight (no adjustment).
  !! 25 = "HR" (variable hours).  26 = RS / VR / VA.
  !! 27 = SR (sunrise).  28 = SS / PM (sunset).
  !! 30 = TRID.  99 = unknown / unrecognised.
  function decode_obtime(obtime) result(code)
    character(len=4), intent(in) :: obtime
    integer :: code
    character(len=2) :: obtim
    integer :: ios

    code = 0

    if (obtime == 'TRID') then
      code = 30
      return
    end if

    ! "xxHR" pattern: HR means "hour", positions 1:2 are the 2-digit hour code
    if (obtime(3:4) == 'HR') then
      read(obtime(1:2), '(i2)', iostat=ios) code
      if (ios /= 0) code = 99
      if (code == 0) code = 24   ! hour 00 = midnight = code 24
      return
    end if

    ! Extract 2-char sub-code: special handling for 9x09 / 9x19 patterns
    if (obtime(1:1) == '9' .and. obtime(4:4) == '9' .and. &
        obtime /= '9909' .and. obtime /= '9919') then
      obtim = obtime(2:3)
    else
      obtim = obtime(3:4)
    end if

    if      (obtim == '00' .or. obtim == '0 ') then
      code = 24
    else if (obtim == 'RS' .or. obtim == 'VR' .or. obtim == 'VA') then
      code = 26
    else if (obtim == 'SR') then
      code = 27
    else if (obtim == 'SS' .or. obtim == 'PM') then
      code = 28
    else if (obtim == '99' .or. obtim == '  ' .or. obtim == 'DE' .or. &
             obtim == 'MI' .or. obtim == '31' .or. obtim == '73' .or. &
             obtim == '78' .or. obtim == '83' .or. obtim == '89' .or. &
             obtim == 'UN') then
      code = 99
    else
      ! Try numeric parse
      read(obtim, '(i2)', iostat=ios) code
      if (ios /= 0) code = 99
    end if

    if (code > 30 .and. code /= 99) then
      call log_warn("TOBUtils: unrecognised obs-time code '" // obtime // "'")
      code = 99
    end if
  end function decode_obtime

  ! ---------------------------------------------------------------------------
  !  tobchg – resolve RS/SR/SS codes into hourly codes for a given month.
  !  Direct port of ushcn_tobs.v6.f TOBCHG.
  ! ---------------------------------------------------------------------------
  subroutine tobchg(month, tob)
    integer, intent(in)    :: month
    integer, intent(inout) :: tob

    ! 26 = RS  →  SR (Apr-Oct),  SS (Nov-Mar)
    if (tob == 26) then
      if (month >= 4 .and. month <= 10) then
        tob = 27
      else
        tob = 28
      end if
    end if

    ! 27 = SR  →  hourly code
    if (tob == 27) then
      if (month == 11 .or. month == 12 .or. month == 1) then
        tob = 8
      else if (month == 2 .or. month == 3 .or. month == 10) then
        tob = 7
      else if (month == 4 .or. month == 8 .or. month == 9) then
        tob = 6
      else   ! May, June, July
        tob = 5
      end if

    ! 28 = SS  →  hourly code
    else if (tob == 28) then
      if (month == 11 .or. month == 12 .or. month == 1) then
        tob = 17
      else if (month == 2 .or. month == 3 .or. month == 10) then
        tob = 18
      else if (month == 4 .or. month == 8 .or. month == 9) then
        tob = 19
      else   ! May, June, July
        tob = 20
      end if
    end if
  end subroutine tobchg

  ! ---------------------------------------------------------------------------
  !  get_timezone – longitude → US time-zone index (1=E, 2=C, 3=M, 4=P)
  !  Matches v3 NRMTOB lines 713-727.
  ! ---------------------------------------------------------------------------
  function get_timezone(lon) result(itz)
    real, intent(in) :: lon
    integer :: itz

    if (lon <= -115.) then
      itz = 4   ! Pacific
    else if (lon <= -103.) then
      itz = 3   ! Mountain
    else if (lon <= -86.) then
      itz = 2   ! Central
    else
      itz = 1   ! Eastern
    end if
  end function get_timezone

  ! ---------------------------------------------------------------------------
  !  compute_bias_tables – public driver.  Builds A(12,24) for the requested
  !  element by calling obtdif for each month.
  !
  !  @param lat         Station latitude (degrees)
  !  @param lon         Station longitude (degrees)
  !  @param itz         Time-zone index (1-4)
  !  @param ltix(0:13)  Long-term monthly means; index 0=Dec(prev), 13=Jan(next)
  !  @param a_table(12,24) On return: bias in degrees C for (month, hour)
  !  @param element     'tmax', 'tmin', or 'tavg'
  ! ---------------------------------------------------------------------------
  subroutine compute_bias_tables(lat, lon, itz, ltix, a_table, element)
    real,    intent(in)  :: lat, lon
    integer, intent(in)  :: itz
    real,    intent(in)  :: ltix(0:13)
    real,    intent(out) :: a_table(12, 24)
    character(len=4), intent(in) :: element

    real :: aobav(24), aobmn(24), aobmx(24)
    real :: slat
    integer :: mo

    slat = lat   ! obtdif may clamp ±90

    do mo = 1, 12
      call obtdif(slat, lon, itz, mo, ltix(mo-1), ltix(mo+1), &
                  aobav, aobmn, aobmx)
      select case (trim(element))
        case ('tmax')
          a_table(mo, :) = aobmx
        case ('tmin')
          a_table(mo, :) = aobmn
        case default   ! tavg
          a_table(mo, :) = aobav
      end select
    end do
  end subroutine compute_bias_tables

  ! ===========================================================================
  !  PRIVATE – solar / quadrant / inter-daily-diff / OBTDIF core
  ! ===========================================================================

  ! ---------------------------------------------------------------------------
  !  find_quad – locate the closest reference station in each of four
  !  geographic quadrants.  Results are cached; recomputed only when lat/lon
  !  change.  Matches v3 QUAD + the caching wrapper in FNDIFF/FNRNG.
  ! ---------------------------------------------------------------------------
  subroutine find_quad(lat, lon)
    real, intent(in) :: lat, lon
    real :: dlat, dlon, olat, dist
    integer :: i

    ! Cache hit
    if (abs(lat - q_lat) < 0.0001 .and. abs(lon - q_lon) < 0.0001) return

    ! New station – reset and scan
    q_lat = lat;  q_lon = lon
    q_dz = 999.;  q_iz = 999

    do i = 1, NSTA_TOB
      dlat = (ALAT(i) - lat)  / 57.29578
      dlon = (ALON(i) - lon)  / 57.29578
      olat = ((ALAT(i) + lat) / 2.) / 57.29578
      dist = abs(6371. * acos(cos(dlat) * cos(abs(dlon) * cos(olat))))

      if (dist >= 500.) cycle

      ! Within 25 km – use directly, no interpolation needed
      if (dist < 25.) then
        q_dz(1) = 0.;  q_iz(1) = i
        return
      end if

      ! Quadrant assignment:  Q1=NE, Q2=NW, Q3=SW, Q4=SE
      if (dlat >= 0.) then
        if (dlon >= 0.) then
          if (dist < q_dz(1)) then;  q_dz(1) = dist;  q_iz(1) = i;  end if
        else
          if (dist < q_dz(2)) then;  q_dz(2) = dist;  q_iz(2) = i;  end if
        end if
      else
        if (dlon >= 0.) then
          if (dist < q_dz(4)) then;  q_dz(4) = dist;  q_iz(4) = i;  end if
        else
          if (dist < q_dz(3)) then;  q_dz(3) = dist;  q_iz(3) = i;  end if
        end if
      end if
    end do
  end subroutine find_quad

  ! ---------------------------------------------------------------------------
  !  fndiff – interpolate inter-daily temperature difference from the four
  !  nearest quadrant reference stations.  Port of v3 FNDIFF.
  ! ---------------------------------------------------------------------------
  function fndiff(lat, lon, imo) result(diff)
    real,    intent(in) :: lat, lon
    integer, intent(in) :: imo
    real :: diff, sdz, stdif
    integer :: i

    call find_quad(lat, lon)

    if (q_dz(1) == 0.) then
      diff = DTDIF(imo, q_iz(1))
    else
      sdz   = 0.;  stdif = 0.
      do i = 1, 4
        if (q_dz(i) /= 999.) then
          sdz   = sdz   + (1. / q_dz(i))
          stdif = stdif + (DTDIF(imo, q_iz(i)) / q_dz(i))
        end if
      end do
      diff = stdif / sdz
    end if
  end function fndiff

  ! ---------------------------------------------------------------------------
  !  fnrng – interpolate December diurnal-range scaling factor.
  !  Port of v3 FNRNG.  Uses same quadrant cache as fndiff.
  ! ---------------------------------------------------------------------------
  function fnrng(lat, lon) result(rng)
    real, intent(in) :: lat, lon
    real :: rng, sdz, srng
    integer :: i

    call find_quad(lat, lon)

    if (q_dz(1) == 0.) then
      rng = sqrt(RHO(q_iz(1)))
    else
      sdz  = 0.;  srng = 0.
      do i = 1, 4
        if (q_dz(i) /= 999.) then
          sdz  = sdz  + (1. / q_dz(i))
          srng = srng + (RHO(q_iz(i)) / q_dz(i))
        end if
      end do
      rng = sqrt(srng / sdz)
    end if
  end function fnrng

  ! ---------------------------------------------------------------------------
  !  solar – mid-month solar elevations and sunrise / sunset times.
  !  Faithful port of v3 SOLAR.
  ! ---------------------------------------------------------------------------
  subroutine solar(lat, lon, itz, imo, elev, sr, ss)
    real,    intent(inout) :: lat          ! may be clamped to ±89.99
    real,    intent(in)    :: lon
    integer, intent(in)    :: itz, imo
    real,    intent(out)   :: elev(24), sr, ss

    real, parameter :: RMO(12) = (/0.,31.,59.,90.,120.,151.,181.,212.,243.,273.,304.,334./)
    real, parameter :: ZONE(4) = (/5.,6.,7.,8./)

    real :: calat, phi, cphi, z, rm, gamma, cgamma, rd
    real :: y_val, rh, crh, tsr, tss, gmt, h, x
    integer :: im

    if (lat ==  90.) lat =  89.99
    if (lat == -90.) lat = -89.99

    calat  = lat / 57.29578
    phi    = 360. * (RMO(imo) + 15.) / 365.242
    cphi   = phi  / 57.29578
    z      = 2.   * cphi

    rm     = 12. + 0.123570*sin(cphi) - 0.004289*cos(cphi) &
                 + 0.153809*sin(z)     + 0.060783*cos(z)

    gamma  = 279.9348 + 1.914827*sin(cphi) - 0.079525*cos(cphi) &
                      + 0.019938*sin(z)     - 0.001620*cos(z) + phi
    cgamma = gamma / 57.29578
    rd     = asin(sin(0.409172) * sin(cgamma))

    y_val  = (sin(-0.014544) - sin(calat)*sin(rd)) &
           / (cos(calat)*cos(rd))

    if (y_val <= -1. .or. y_val >= 1.) then
      tsr = 0.;  tss = 24.
    else
      rh  = acos(y_val)
      crh = rh * 57.29578
      tsr = (abs(lon) / 15.) + rm - (crh / 15.)
      tss = (abs(lon) / 15.) + rm + (crh / 15.)
    end if

    sr = tsr - ZONE(itz)
    ss = tss - ZONE(itz)

    if (sr <= 0.)  sr = sr + 24.
    if (sr >= 24.) sr = sr - 24.
    if (ss <= 0.)  ss = ss + 24.
    if (ss >= 24.) ss = ss - 24.

    do im = 0, 23
      gmt = im + ZONE(itz) + 0.5
      if (gmt >= 24.) gmt = gmt - 24.
      h   = (15. * (gmt - rm) - abs(lon)) / 57.29578
      x   = sin(calat)*sin(rd) + cos(calat)*cos(rd)*cos(h)
      elev(im+1) = asin(x) * 57.29578
    end do
  end subroutine solar

  ! ---------------------------------------------------------------------------
  !  obtdif – compute the 24-hour bias curves for all three elements for
  !  one month.  Port of v3 OBTDIF (IDFLG=0, Celsius).
  !
  !  BASXX arrays use 1:24 indexing mapping to the original -12:+11 offsets
  !  (new_idx = original + 13).  ISR starts at  -NINT(SR)+14  and wraps at
  !  24→1 matching the original ISR+1 / wrap-at-12→-12 pattern.
  ! ---------------------------------------------------------------------------
  subroutine obtdif(lat, lon, itz, imo, amt1, amt2, aobav, aobmn, aobmx)
    real,    intent(inout) :: lat
    real,    intent(in)    :: lon, amt1, amt2
    integer, intent(in)    :: itz, imo
    real,    intent(out)   :: aobav(24), aobmn(24), aobmx(24)

    real    :: elev(24), sr, ss, elevhi, aidif
    real    :: drifta, driftn, driftx, ratio
    integer :: ibc, isr, ihr, m

    call solar(lat, lon, itz, imo, elev, sr, ss)

    ! Highest solar elevation → base-curve column (IBC)
    elevhi = 0.
    do m = 1, 24
      if (elev(m) > elevhi) elevhi = elev(m)
    end do
    ibc = 12
    do m = 1, 11
      if (RELEV(m) > elevhi) then;  ibc = m;  exit;  end if
    end do

    ! Starting base-curve row (1:24 space)
    isr = -nint(sr) + 14
    if (isr < 1)  isr = isr + 24
    if (isr > 24) isr = isr - 24

    ! Inter-daily temperature difference
    aidif = fndiff(lat, lon, imo)
    if (imo == 12) aidif = aidif * fnrng(lat, lon)

    ! Drift (monthly-mean method, IDFLG = 0)
    drifta = (amt2 - amt1) / (2. * DAYS_MON(imo))
    driftn = drifta;  driftx = drifta

    ! 23 hourly biases
    do ihr = 1, 23
      ratio      = (real(ihr) - 24.) / 24.
      aobav(ihr) = CFAV(imo)*BASAV(ibc,isr)*aidif + drifta*ratio
      aobmn(ihr) = CFMN(imo)*BASMN(ibc,isr)*aidif + driftn*ratio
      aobmx(ihr) = CFMX(imo)*BASMX(ibc,isr)*aidif + driftx*ratio
      isr = isr + 1
      if (isr > 24) isr = 1
    end do

    ! Hour 24 (midnight) = zero bias
    aobav(24) = 0.;  aobmn(24) = 0.;  aobmx(24) = 0.
  end subroutine obtdif

end module TOBUtils

!> @file
!! TOB-adjustment utility module – calibration tables and Karl et al. bias
!! estimation algorithm.
